(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var twixlyExtension = {
  window: {
    updateHeight: function (height) {
      updateIframeHeight(height);
    }
  },
  field: {
    id: null,
    schema: null,
    ui_schema: null,
    getValue: function () {
      return twixlyField.value;
    },
    setValue: function (value) {
      return postMessenger.call('extension_field_set_value', {field_id: twixlyField.id, type: twixlyExtension.field.schema.type, value: value});
    },
    setInvalid: function (value) {
      return postMessenger.call('extension_field_set_invalid', {field_id: twixlyField.id, value: value});
    },
    validate: function (value) {
      return postMessenger.call('extension_field_validate', {field_id: twixlyField.id});
    },
    onChange: function (cb, runInitValueChanged) {
      if (runInitValueChanged && twixlyFieldEvents.changeInitValue) {
        cb(twixlyFieldEvents.changeInitValue);
      }
      twixlyFieldEvents.changeInitValue = null;
      twixlyFieldEvents.valueChanged = cb;
    },
    onValidate: function (cb) {
      if (twixlyFieldEvents.validationInitValue) {
        cb(twixlyFieldEvents.validationInitValue);
      }
      twixlyFieldEvents.validationInitValue = null;
      twixlyFieldEvents.validation = cb;
    },
    setFullscreen: function (bool) {
      return postMessenger.call('extension_field_set_fullscreen', { bool: bool });
    }
  },
  form: {
    submit: function () {
      return postMessenger.call('extension_form_submit');
    },
    setPadding: function (height) {
      return postMessenger.call('extension_form_set_padding', { height: height });
    }
  },
  itemType: null,
  item: null,
  bucket: {
    get: function (endPoint, options) {
      return postMessenger.call('extension_bucket_get', {endPoint: endPoint, options: options});
    },
    post: function (endPoint, data) {
      return postMessenger.call('extension_bucket_post', {endPoint: endPoint, data: data});
    },
    put: function (endPoint, data) {
      return postMessenger.call('extension_bucket_put', {endPoint: endPoint, data: data});
    },
    delete: function (endPoint) {
      return postMessenger.call('extension_bucket_delete', {endPoint: endPoint});
    }
  },
  dialogs: {
    selectSingleItem: function (options) {
      return postMessenger.call('extension_dialogs_select_single_item', options);
    },
    selectMultipleItems: function (options) {
      return postMessenger.call('extension_dialogs_select_multiple_items', options);
    },
    selectSingleMedia: function (options) {
      return postMessenger.call('extension_dialogs_select_single_media', options);
    },
    selectMultipleMedia: function (options) {
      return postMessenger.call('extension_dialogs_select_multiple_media', options);
    },
    editItem: function (itemId, options) {
      return postMessenger.call('extension_dialogs_edit_item', {itemId: itemId, options: options});
    },
    editMediaItem: function (itemId, options) {
      return postMessenger.call('extension_dialogs_edit_media_item', {itemId: itemId, options: options});
    }
  }
};

var twixlyField = {
  value: undefined,
  id: undefined
}

var itemUpdate = null;

class PostMessenger {
  constructor(iframeId) {
    this._responseHandlers = {};

    this._dispatch = setPostMessage(iframeId);

    window.addEventListener('message', (event) => {
      this._onMessage(event.data);
    })
  }

  call(method, params) {
    const msgId = this._dispatch(method, params);
    return new Promise((resolve, reject) => {
      this._responseHandlers[msgId] = {resolve, reject}
    })
  }

  dispatch(method, params) {
    this._send(method, params)
  }

  _onMessage(message) {
    if (message.method === 'external_field') {
      if (itemUpdate) {
        itemUpdate.attributes[message.data.id].value = message.data.value;
        itemUpdate.attributes[message.data.id].errors = message.data.errors;
        if (twixlyFieldEvents.item.attributes[message.data.id] && twixlyFieldEvents.item.attributes[message.data.id].valueChanged) {
          var v = JSON.parse(JSON.stringify(itemUpdate.attributes[message.data.id]));
          // delete v.value;
          twixlyFieldEvents.item.attributes[message.data.id].valueChanged(v);
        }
      } else {
        // console.log('The extension where not loaded before another field sent an update to it. This is ok because if this field is not loaded yet it doesn't care about other fields data. This field name is: ' + message.data.id + '.');
      }
      return;
    }
    if (message.data) {
      if ((message.method === 'extension_field_set_value')) {
        if (twixlyFieldEvents.valueChanged) {
          twixlyFieldEvents.valueChanged(message.data);
        }
      }
      if ((message.method === 'extension_field_validate')) {
        if (twixlyFieldEvents.validation) {
          twixlyFieldEvents.validation(message.data);
        }
      }
      // if ((message.method === 'extension_field_check_focus')) {
      //   if (twixlyFieldEvents.focus) {
      //     twixlyFieldEvents.focus(message.data);
      //   }
      // }
    }
    if (message.id >= 0) {
      var id = message.id;
      var responseHandler = this._responseHandlers[id];
      if (!responseHandler) {
        return
      }
      if (message.init_extension) {
        twixlyField.value = message.data.value;
        // twixlyExtension.field.value = message.data.value;
        twixlyField.id = message.data.id;
        twixlyExtension.field.schema = message.data.schema;
        twixlyExtension.field.ui_schema = message.data.ui_schema;
        twixlyExtension.field.id = message.data.name;
        twixlyExtension.itemType = message.data.item_type;
        itemUpdate = JSON.parse(JSON.stringify(message.data.item));
        var item = JSON.parse(JSON.stringify(message.data.item));
        if (item.attributes) {
          for (var propKey in item.attributes) {
            var prop = item.attributes[propKey];
            prop.getValue = function() {
              return itemUpdate.attributes[this.id].value;
            }
            prop.setValue = function(value) {
              return postMessenger.call('extension_item_attributes_set_value', {field_id: this.id, value: value});
            }
            prop.onChange = function(cb) {
              twixlyFieldEvents.item.attributes[this.id] = {
                valueChanged: cb
              }
            }
            delete prop.value;
            // prop.onValidate = function(cb) {
            //   twixlyFieldEvents.item.attributes[this.id] = {
            //     validation: cb
            //   }
            // }
          }
        }
        twixlyExtension.item = item;
        var initValue = {
          isValid: message.data.isValid,
          errors: message.data.errors,
          value: message.data.value
        };
        twixlyFieldEvents.changeInitValue = initValue;
        twixlyFieldEvents.validationInitValue = initValue;
        // twixlyFieldEvents.focusInitValue = initValue;
        responseHandler.resolve(twixlyExtension);
        // Check if parent field is focused
        // postMessenger.call('extension_field_check_focus', {field_id: twixlyField.id});
      } else if (message.method.startsWith('extension_bucket_')) {
        if (message.data.errors) {
          responseHandler.reject(message.data.errors);
        } else {
          responseHandler.resolve(message.data.res);  
        }
      } else if (message.method.startsWith('extension_dialogs_select_')) {
        if (message.data.errors) {
          responseHandler.reject(message.data.errors);
        } else {
          responseHandler.resolve(message.data.res);  
        }
      } else if (message.method.startsWith('extension_dialogs_edit_')) {
        if (message.data.errors) {
          responseHandler.reject(message.data.errors);
        } else {
          responseHandler.resolve(message.data.res);
        }
      } else if (message.data) {
        if (message.data && typeof message.data.value !== 'undefined') {
          twixlyField.value = message.data.value;
          // twixlyExtension.field.value = message.data.value;
        }
        responseHandler.resolve(message.data);
      } else if (message.error) {
        responseHandler.reject(message.error);
      }
      delete this._responseHandlers[id];
    }
  } 
}

function setPostMessage (iframeId) {
  let msgCount = 0
  return function dispatch (method, params) {
    const msgId = msgCount++
    parent.postMessage({
      iframeId: iframeId,
      id: msgId,
      method,
      params
    }, '*');
    return msgId
  }
}

var twixlyFieldEvents = {
  onChange: null,
  onValidate: null,
  // onFocus: null,
  changeInitValue: null,
  validationInitValue: null,
  // focusInitValue: null,
  item: {
    attributes: {}
  }
}

var getQueryString = function (name) {
  var result = null;
  var regexS = "[\\?&#]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec('?' + window.location.href.split('?')[1]);
  if (results != null) {
    result = decodeURIComponent(results[1].replace(/\+/g, " "));
  }
  return result;
}

var iframeId = getQueryString('iframe_id');
var fieldId = getQueryString('field_id');

// Functions
function updateIframeHeight(height) {
  var interval = 50;
  var timeout = 500;
  var theInterval = setInterval(function(){sendHeight(height);}, interval);
  setTimeout(function() { clearInterval(theInterval); }, timeout);
  function sendHeight(height) {
    var height = height || document.body.offsetHeight;
    var targetWindow = parent.frames;
    var obj = {
      action: 'extension_update_height',
      height: height,
      id: iframeId
    }
    targetWindow.postMessage(obj, '*');
  }
  sendHeight(height);
}

Extension = function() {}
Extension.prototype.init = function(options) {
  // let promise = new Promise((resolve, reject) => {
    // { disableDefault: ['*'] }
    options = options ?
              options :
              {};
    options.height = options.height || document.body.offsetHeight;
    // if (!options && options.disableDefault) {
    //   postMessenger.call('extension_field_disable_default', {field_id: twixlyField.id, value: options.disableDefault});
    // }
    return postMessenger.call('extension_init', {field_id: fieldId, options: options});
    // function callback() {
    //   // if (options && options.disableDefault) {
    //   //   postMessenger.call('extension_field_disable_default', {field_id: twixlyField.id, value: options.disableDefault});
    //   // }
    //   resolve(twixlyExtension);
    // }
    // if (
    //   document.readyState === 'complete'// ||
    //   //(document.readyState !== 'loading' && !document.documentElement.doScroll)
    // ) {
    //   callback();
    // } else {
    //   document.addEventListener('DOMContentLoaded', callback);
    // }
    // function goo() {
    //   if (document.readyState === 'complete') {
    //     callback();
    //   } else {
    //     setTimeout(function() { goo() }, 1);
    //   }
    // }
    // goo();
  // });
  // return promise;
}

var postMessenger = new PostMessenger(iframeId);

window.twixly = {};
window.twixly.call = function(method, params) {
  return postMessenger.call(method, params);
}
window.twixly.extension = new Extension;
window.twixlyExtension = window.twixly.extension;
},{}]},{},[1])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJpbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsInZhciB0d2l4bHlFeHRlbnNpb24gPSB7XG4gIHdpbmRvdzoge1xuICAgIHVwZGF0ZUhlaWdodDogZnVuY3Rpb24gKGhlaWdodCkge1xuICAgICAgdXBkYXRlSWZyYW1lSGVpZ2h0KGhlaWdodCk7XG4gICAgfVxuICB9LFxuICBmaWVsZDoge1xuICAgIGlkOiBudWxsLFxuICAgIHNjaGVtYTogbnVsbCxcbiAgICB1aV9zY2hlbWE6IG51bGwsXG4gICAgZ2V0VmFsdWU6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiB0d2l4bHlGaWVsZC52YWx1ZTtcbiAgICB9LFxuICAgIHNldFZhbHVlOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9maWVsZF9zZXRfdmFsdWUnLCB7ZmllbGRfaWQ6IHR3aXhseUZpZWxkLmlkLCB0eXBlOiB0d2l4bHlFeHRlbnNpb24uZmllbGQuc2NoZW1hLnR5cGUsIHZhbHVlOiB2YWx1ZX0pO1xuICAgIH0sXG4gICAgc2V0SW52YWxpZDogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICByZXR1cm4gcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25fZmllbGRfc2V0X2ludmFsaWQnLCB7ZmllbGRfaWQ6IHR3aXhseUZpZWxkLmlkLCB2YWx1ZTogdmFsdWV9KTtcbiAgICB9LFxuICAgIHZhbGlkYXRlOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9maWVsZF92YWxpZGF0ZScsIHtmaWVsZF9pZDogdHdpeGx5RmllbGQuaWR9KTtcbiAgICB9LFxuICAgIG9uQ2hhbmdlOiBmdW5jdGlvbiAoY2IsIHJ1bkluaXRWYWx1ZUNoYW5nZWQpIHtcbiAgICAgIGlmIChydW5Jbml0VmFsdWVDaGFuZ2VkICYmIHR3aXhseUZpZWxkRXZlbnRzLmNoYW5nZUluaXRWYWx1ZSkge1xuICAgICAgICBjYih0d2l4bHlGaWVsZEV2ZW50cy5jaGFuZ2VJbml0VmFsdWUpO1xuICAgICAgfVxuICAgICAgdHdpeGx5RmllbGRFdmVudHMuY2hhbmdlSW5pdFZhbHVlID0gbnVsbDtcbiAgICAgIHR3aXhseUZpZWxkRXZlbnRzLnZhbHVlQ2hhbmdlZCA9IGNiO1xuICAgIH0sXG4gICAgb25WYWxpZGF0ZTogZnVuY3Rpb24gKGNiKSB7XG4gICAgICBpZiAodHdpeGx5RmllbGRFdmVudHMudmFsaWRhdGlvbkluaXRWYWx1ZSkge1xuICAgICAgICBjYih0d2l4bHlGaWVsZEV2ZW50cy52YWxpZGF0aW9uSW5pdFZhbHVlKTtcbiAgICAgIH1cbiAgICAgIHR3aXhseUZpZWxkRXZlbnRzLnZhbGlkYXRpb25Jbml0VmFsdWUgPSBudWxsO1xuICAgICAgdHdpeGx5RmllbGRFdmVudHMudmFsaWRhdGlvbiA9IGNiO1xuICAgIH0sXG4gICAgc2V0RnVsbHNjcmVlbjogZnVuY3Rpb24gKGJvb2wpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9maWVsZF9zZXRfZnVsbHNjcmVlbicsIHsgYm9vbDogYm9vbCB9KTtcbiAgICB9XG4gIH0sXG4gIGZvcm06IHtcbiAgICBzdWJtaXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9mb3JtX3N1Ym1pdCcpO1xuICAgIH0sXG4gICAgc2V0UGFkZGluZzogZnVuY3Rpb24gKGhlaWdodCkge1xuICAgICAgcmV0dXJuIHBvc3RNZXNzZW5nZXIuY2FsbCgnZXh0ZW5zaW9uX2Zvcm1fc2V0X3BhZGRpbmcnLCB7IGhlaWdodDogaGVpZ2h0IH0pO1xuICAgIH1cbiAgfSxcbiAgaXRlbVR5cGU6IG51bGwsXG4gIGl0ZW06IG51bGwsXG4gIGJ1Y2tldDoge1xuICAgIGdldDogZnVuY3Rpb24gKGVuZFBvaW50LCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25fYnVja2V0X2dldCcsIHtlbmRQb2ludDogZW5kUG9pbnQsIG9wdGlvbnM6IG9wdGlvbnN9KTtcbiAgICB9LFxuICAgIHBvc3Q6IGZ1bmN0aW9uIChlbmRQb2ludCwgZGF0YSkge1xuICAgICAgcmV0dXJuIHBvc3RNZXNzZW5nZXIuY2FsbCgnZXh0ZW5zaW9uX2J1Y2tldF9wb3N0Jywge2VuZFBvaW50OiBlbmRQb2ludCwgZGF0YTogZGF0YX0pO1xuICAgIH0sXG4gICAgcHV0OiBmdW5jdGlvbiAoZW5kUG9pbnQsIGRhdGEpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9idWNrZXRfcHV0Jywge2VuZFBvaW50OiBlbmRQb2ludCwgZGF0YTogZGF0YX0pO1xuICAgIH0sXG4gICAgZGVsZXRlOiBmdW5jdGlvbiAoZW5kUG9pbnQpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9idWNrZXRfZGVsZXRlJywge2VuZFBvaW50OiBlbmRQb2ludH0pO1xuICAgIH1cbiAgfSxcbiAgZGlhbG9nczoge1xuICAgIHNlbGVjdFNpbmdsZUl0ZW06IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICByZXR1cm4gcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25fZGlhbG9nc19zZWxlY3Rfc2luZ2xlX2l0ZW0nLCBvcHRpb25zKTtcbiAgICB9LFxuICAgIHNlbGVjdE11bHRpcGxlSXRlbXM6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICByZXR1cm4gcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25fZGlhbG9nc19zZWxlY3RfbXVsdGlwbGVfaXRlbXMnLCBvcHRpb25zKTtcbiAgICB9LFxuICAgIHNlbGVjdFNpbmdsZU1lZGlhOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgcmV0dXJuIHBvc3RNZXNzZW5nZXIuY2FsbCgnZXh0ZW5zaW9uX2RpYWxvZ3Nfc2VsZWN0X3NpbmdsZV9tZWRpYScsIG9wdGlvbnMpO1xuICAgIH0sXG4gICAgc2VsZWN0TXVsdGlwbGVNZWRpYTogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9kaWFsb2dzX3NlbGVjdF9tdWx0aXBsZV9tZWRpYScsIG9wdGlvbnMpO1xuICAgIH0sXG4gICAgZWRpdEl0ZW06IGZ1bmN0aW9uIChpdGVtSWQsIG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwoJ2V4dGVuc2lvbl9kaWFsb2dzX2VkaXRfaXRlbScsIHtpdGVtSWQ6IGl0ZW1JZCwgb3B0aW9uczogb3B0aW9uc30pO1xuICAgIH0sXG4gICAgZWRpdE1lZGlhSXRlbTogZnVuY3Rpb24gKGl0ZW1JZCwgb3B0aW9ucykge1xuICAgICAgcmV0dXJuIHBvc3RNZXNzZW5nZXIuY2FsbCgnZXh0ZW5zaW9uX2RpYWxvZ3NfZWRpdF9tZWRpYV9pdGVtJywge2l0ZW1JZDogaXRlbUlkLCBvcHRpb25zOiBvcHRpb25zfSk7XG4gICAgfVxuICB9XG59O1xuXG52YXIgdHdpeGx5RmllbGQgPSB7XG4gIHZhbHVlOiB1bmRlZmluZWQsXG4gIGlkOiB1bmRlZmluZWRcbn1cblxudmFyIGl0ZW1VcGRhdGUgPSBudWxsO1xuXG5jbGFzcyBQb3N0TWVzc2VuZ2VyIHtcbiAgY29uc3RydWN0b3IoaWZyYW1lSWQpIHtcbiAgICB0aGlzLl9yZXNwb25zZUhhbmRsZXJzID0ge307XG5cbiAgICB0aGlzLl9kaXNwYXRjaCA9IHNldFBvc3RNZXNzYWdlKGlmcmFtZUlkKTtcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGV2ZW50KSA9PiB7XG4gICAgICB0aGlzLl9vbk1lc3NhZ2UoZXZlbnQuZGF0YSk7XG4gICAgfSlcbiAgfVxuXG4gIGNhbGwobWV0aG9kLCBwYXJhbXMpIHtcbiAgICBjb25zdCBtc2dJZCA9IHRoaXMuX2Rpc3BhdGNoKG1ldGhvZCwgcGFyYW1zKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5fcmVzcG9uc2VIYW5kbGVyc1ttc2dJZF0gPSB7cmVzb2x2ZSwgcmVqZWN0fVxuICAgIH0pXG4gIH1cblxuICBkaXNwYXRjaChtZXRob2QsIHBhcmFtcykge1xuICAgIHRoaXMuX3NlbmQobWV0aG9kLCBwYXJhbXMpXG4gIH1cblxuICBfb25NZXNzYWdlKG1lc3NhZ2UpIHtcbiAgICBpZiAobWVzc2FnZS5tZXRob2QgPT09ICdleHRlcm5hbF9maWVsZCcpIHtcbiAgICAgIGlmIChpdGVtVXBkYXRlKSB7XG4gICAgICAgIGl0ZW1VcGRhdGUuYXR0cmlidXRlc1ttZXNzYWdlLmRhdGEuaWRdLnZhbHVlID0gbWVzc2FnZS5kYXRhLnZhbHVlO1xuICAgICAgICBpdGVtVXBkYXRlLmF0dHJpYnV0ZXNbbWVzc2FnZS5kYXRhLmlkXS5lcnJvcnMgPSBtZXNzYWdlLmRhdGEuZXJyb3JzO1xuICAgICAgICBpZiAodHdpeGx5RmllbGRFdmVudHMuaXRlbS5hdHRyaWJ1dGVzW21lc3NhZ2UuZGF0YS5pZF0gJiYgdHdpeGx5RmllbGRFdmVudHMuaXRlbS5hdHRyaWJ1dGVzW21lc3NhZ2UuZGF0YS5pZF0udmFsdWVDaGFuZ2VkKSB7XG4gICAgICAgICAgdmFyIHYgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGl0ZW1VcGRhdGUuYXR0cmlidXRlc1ttZXNzYWdlLmRhdGEuaWRdKSk7XG4gICAgICAgICAgLy8gZGVsZXRlIHYudmFsdWU7XG4gICAgICAgICAgdHdpeGx5RmllbGRFdmVudHMuaXRlbS5hdHRyaWJ1dGVzW21lc3NhZ2UuZGF0YS5pZF0udmFsdWVDaGFuZ2VkKHYpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBjb25zb2xlLmxvZygnVGhlIGV4dGVuc2lvbiB3aGVyZSBub3QgbG9hZGVkIGJlZm9yZSBhbm90aGVyIGZpZWxkIHNlbnQgYW4gdXBkYXRlIHRvIGl0LiBUaGlzIGlzIG9rIGJlY2F1c2UgaWYgdGhpcyBmaWVsZCBpcyBub3QgbG9hZGVkIHlldCBpdCBkb2Vzbid0IGNhcmUgYWJvdXQgb3RoZXIgZmllbGRzIGRhdGEuIFRoaXMgZmllbGQgbmFtZSBpczogJyArIG1lc3NhZ2UuZGF0YS5pZCArICcuJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChtZXNzYWdlLmRhdGEpIHtcbiAgICAgIGlmICgobWVzc2FnZS5tZXRob2QgPT09ICdleHRlbnNpb25fZmllbGRfc2V0X3ZhbHVlJykpIHtcbiAgICAgICAgaWYgKHR3aXhseUZpZWxkRXZlbnRzLnZhbHVlQ2hhbmdlZCkge1xuICAgICAgICAgIHR3aXhseUZpZWxkRXZlbnRzLnZhbHVlQ2hhbmdlZChtZXNzYWdlLmRhdGEpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoKG1lc3NhZ2UubWV0aG9kID09PSAnZXh0ZW5zaW9uX2ZpZWxkX3ZhbGlkYXRlJykpIHtcbiAgICAgICAgaWYgKHR3aXhseUZpZWxkRXZlbnRzLnZhbGlkYXRpb24pIHtcbiAgICAgICAgICB0d2l4bHlGaWVsZEV2ZW50cy52YWxpZGF0aW9uKG1lc3NhZ2UuZGF0YSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIGlmICgobWVzc2FnZS5tZXRob2QgPT09ICdleHRlbnNpb25fZmllbGRfY2hlY2tfZm9jdXMnKSkge1xuICAgICAgLy8gICBpZiAodHdpeGx5RmllbGRFdmVudHMuZm9jdXMpIHtcbiAgICAgIC8vICAgICB0d2l4bHlGaWVsZEV2ZW50cy5mb2N1cyhtZXNzYWdlLmRhdGEpO1xuICAgICAgLy8gICB9XG4gICAgICAvLyB9XG4gICAgfVxuICAgIGlmIChtZXNzYWdlLmlkID49IDApIHtcbiAgICAgIHZhciBpZCA9IG1lc3NhZ2UuaWQ7XG4gICAgICB2YXIgcmVzcG9uc2VIYW5kbGVyID0gdGhpcy5fcmVzcG9uc2VIYW5kbGVyc1tpZF07XG4gICAgICBpZiAoIXJlc3BvbnNlSGFuZGxlcikge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGlmIChtZXNzYWdlLmluaXRfZXh0ZW5zaW9uKSB7XG4gICAgICAgIHR3aXhseUZpZWxkLnZhbHVlID0gbWVzc2FnZS5kYXRhLnZhbHVlO1xuICAgICAgICAvLyB0d2l4bHlFeHRlbnNpb24uZmllbGQudmFsdWUgPSBtZXNzYWdlLmRhdGEudmFsdWU7XG4gICAgICAgIHR3aXhseUZpZWxkLmlkID0gbWVzc2FnZS5kYXRhLmlkO1xuICAgICAgICB0d2l4bHlFeHRlbnNpb24uZmllbGQuc2NoZW1hID0gbWVzc2FnZS5kYXRhLnNjaGVtYTtcbiAgICAgICAgdHdpeGx5RXh0ZW5zaW9uLmZpZWxkLnVpX3NjaGVtYSA9IG1lc3NhZ2UuZGF0YS51aV9zY2hlbWE7XG4gICAgICAgIHR3aXhseUV4dGVuc2lvbi5maWVsZC5pZCA9IG1lc3NhZ2UuZGF0YS5uYW1lO1xuICAgICAgICB0d2l4bHlFeHRlbnNpb24uaXRlbVR5cGUgPSBtZXNzYWdlLmRhdGEuaXRlbV90eXBlO1xuICAgICAgICBpdGVtVXBkYXRlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShtZXNzYWdlLmRhdGEuaXRlbSkpO1xuICAgICAgICB2YXIgaXRlbSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkobWVzc2FnZS5kYXRhLml0ZW0pKTtcbiAgICAgICAgaWYgKGl0ZW0uYXR0cmlidXRlcykge1xuICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gaXRlbS5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICB2YXIgcHJvcCA9IGl0ZW0uYXR0cmlidXRlc1twcm9wS2V5XTtcbiAgICAgICAgICAgIHByb3AuZ2V0VmFsdWUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGl0ZW1VcGRhdGUuYXR0cmlidXRlc1t0aGlzLmlkXS52YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHByb3Auc2V0VmFsdWUgPSBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICAgICAgICByZXR1cm4gcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25faXRlbV9hdHRyaWJ1dGVzX3NldF92YWx1ZScsIHtmaWVsZF9pZDogdGhpcy5pZCwgdmFsdWU6IHZhbHVlfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwcm9wLm9uQ2hhbmdlID0gZnVuY3Rpb24oY2IpIHtcbiAgICAgICAgICAgICAgdHdpeGx5RmllbGRFdmVudHMuaXRlbS5hdHRyaWJ1dGVzW3RoaXMuaWRdID0ge1xuICAgICAgICAgICAgICAgIHZhbHVlQ2hhbmdlZDogY2JcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGVsZXRlIHByb3AudmFsdWU7XG4gICAgICAgICAgICAvLyBwcm9wLm9uVmFsaWRhdGUgPSBmdW5jdGlvbihjYikge1xuICAgICAgICAgICAgLy8gICB0d2l4bHlGaWVsZEV2ZW50cy5pdGVtLmF0dHJpYnV0ZXNbdGhpcy5pZF0gPSB7XG4gICAgICAgICAgICAvLyAgICAgdmFsaWRhdGlvbjogY2JcbiAgICAgICAgICAgIC8vICAgfVxuICAgICAgICAgICAgLy8gfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0d2l4bHlFeHRlbnNpb24uaXRlbSA9IGl0ZW07XG4gICAgICAgIHZhciBpbml0VmFsdWUgPSB7XG4gICAgICAgICAgaXNWYWxpZDogbWVzc2FnZS5kYXRhLmlzVmFsaWQsXG4gICAgICAgICAgZXJyb3JzOiBtZXNzYWdlLmRhdGEuZXJyb3JzLFxuICAgICAgICAgIHZhbHVlOiBtZXNzYWdlLmRhdGEudmFsdWVcbiAgICAgICAgfTtcbiAgICAgICAgdHdpeGx5RmllbGRFdmVudHMuY2hhbmdlSW5pdFZhbHVlID0gaW5pdFZhbHVlO1xuICAgICAgICB0d2l4bHlGaWVsZEV2ZW50cy52YWxpZGF0aW9uSW5pdFZhbHVlID0gaW5pdFZhbHVlO1xuICAgICAgICAvLyB0d2l4bHlGaWVsZEV2ZW50cy5mb2N1c0luaXRWYWx1ZSA9IGluaXRWYWx1ZTtcbiAgICAgICAgcmVzcG9uc2VIYW5kbGVyLnJlc29sdmUodHdpeGx5RXh0ZW5zaW9uKTtcbiAgICAgICAgLy8gQ2hlY2sgaWYgcGFyZW50IGZpZWxkIGlzIGZvY3VzZWRcbiAgICAgICAgLy8gcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25fZmllbGRfY2hlY2tfZm9jdXMnLCB7ZmllbGRfaWQ6IHR3aXhseUZpZWxkLmlkfSk7XG4gICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UubWV0aG9kLnN0YXJ0c1dpdGgoJ2V4dGVuc2lvbl9idWNrZXRfJykpIHtcbiAgICAgICAgaWYgKG1lc3NhZ2UuZGF0YS5lcnJvcnMpIHtcbiAgICAgICAgICByZXNwb25zZUhhbmRsZXIucmVqZWN0KG1lc3NhZ2UuZGF0YS5lcnJvcnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3BvbnNlSGFuZGxlci5yZXNvbHZlKG1lc3NhZ2UuZGF0YS5yZXMpOyAgXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAobWVzc2FnZS5tZXRob2Quc3RhcnRzV2l0aCgnZXh0ZW5zaW9uX2RpYWxvZ3Nfc2VsZWN0XycpKSB7XG4gICAgICAgIGlmIChtZXNzYWdlLmRhdGEuZXJyb3JzKSB7XG4gICAgICAgICAgcmVzcG9uc2VIYW5kbGVyLnJlamVjdChtZXNzYWdlLmRhdGEuZXJyb3JzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNwb25zZUhhbmRsZXIucmVzb2x2ZShtZXNzYWdlLmRhdGEucmVzKTsgIFxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UubWV0aG9kLnN0YXJ0c1dpdGgoJ2V4dGVuc2lvbl9kaWFsb2dzX2VkaXRfJykpIHtcbiAgICAgICAgaWYgKG1lc3NhZ2UuZGF0YS5lcnJvcnMpIHtcbiAgICAgICAgICByZXNwb25zZUhhbmRsZXIucmVqZWN0KG1lc3NhZ2UuZGF0YS5lcnJvcnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3BvbnNlSGFuZGxlci5yZXNvbHZlKG1lc3NhZ2UuZGF0YS5yZXMpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UuZGF0YSkge1xuICAgICAgICBpZiAobWVzc2FnZS5kYXRhICYmIHR5cGVvZiBtZXNzYWdlLmRhdGEudmFsdWUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgdHdpeGx5RmllbGQudmFsdWUgPSBtZXNzYWdlLmRhdGEudmFsdWU7XG4gICAgICAgICAgLy8gdHdpeGx5RXh0ZW5zaW9uLmZpZWxkLnZhbHVlID0gbWVzc2FnZS5kYXRhLnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHJlc3BvbnNlSGFuZGxlci5yZXNvbHZlKG1lc3NhZ2UuZGF0YSk7XG4gICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UuZXJyb3IpIHtcbiAgICAgICAgcmVzcG9uc2VIYW5kbGVyLnJlamVjdChtZXNzYWdlLmVycm9yKTtcbiAgICAgIH1cbiAgICAgIGRlbGV0ZSB0aGlzLl9yZXNwb25zZUhhbmRsZXJzW2lkXTtcbiAgICB9XG4gIH0gXG59XG5cbmZ1bmN0aW9uIHNldFBvc3RNZXNzYWdlIChpZnJhbWVJZCkge1xuICBsZXQgbXNnQ291bnQgPSAwXG4gIHJldHVybiBmdW5jdGlvbiBkaXNwYXRjaCAobWV0aG9kLCBwYXJhbXMpIHtcbiAgICBjb25zdCBtc2dJZCA9IG1zZ0NvdW50KytcbiAgICBwYXJlbnQucG9zdE1lc3NhZ2Uoe1xuICAgICAgaWZyYW1lSWQ6IGlmcmFtZUlkLFxuICAgICAgaWQ6IG1zZ0lkLFxuICAgICAgbWV0aG9kLFxuICAgICAgcGFyYW1zXG4gICAgfSwgJyonKTtcbiAgICByZXR1cm4gbXNnSWRcbiAgfVxufVxuXG52YXIgdHdpeGx5RmllbGRFdmVudHMgPSB7XG4gIG9uQ2hhbmdlOiBudWxsLFxuICBvblZhbGlkYXRlOiBudWxsLFxuICAvLyBvbkZvY3VzOiBudWxsLFxuICBjaGFuZ2VJbml0VmFsdWU6IG51bGwsXG4gIHZhbGlkYXRpb25Jbml0VmFsdWU6IG51bGwsXG4gIC8vIGZvY3VzSW5pdFZhbHVlOiBudWxsLFxuICBpdGVtOiB7XG4gICAgYXR0cmlidXRlczoge31cbiAgfVxufVxuXG52YXIgZ2V0UXVlcnlTdHJpbmcgPSBmdW5jdGlvbiAobmFtZSkge1xuICB2YXIgcmVzdWx0ID0gbnVsbDtcbiAgdmFyIHJlZ2V4UyA9IFwiW1xcXFw/JiNdXCIgKyBuYW1lICsgXCI9KFteJiNdKilcIjtcbiAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cChyZWdleFMpO1xuICB2YXIgcmVzdWx0cyA9IHJlZ2V4LmV4ZWMoJz8nICsgd2luZG93LmxvY2F0aW9uLmhyZWYuc3BsaXQoJz8nKVsxXSk7XG4gIGlmIChyZXN1bHRzICE9IG51bGwpIHtcbiAgICByZXN1bHQgPSBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1sxXS5yZXBsYWNlKC9cXCsvZywgXCIgXCIpKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG52YXIgaWZyYW1lSWQgPSBnZXRRdWVyeVN0cmluZygnaWZyYW1lX2lkJyk7XG52YXIgZmllbGRJZCA9IGdldFF1ZXJ5U3RyaW5nKCdmaWVsZF9pZCcpO1xuXG4vLyBGdW5jdGlvbnNcbmZ1bmN0aW9uIHVwZGF0ZUlmcmFtZUhlaWdodChoZWlnaHQpIHtcbiAgdmFyIGludGVydmFsID0gNTA7XG4gIHZhciB0aW1lb3V0ID0gNTAwO1xuICB2YXIgdGhlSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpe3NlbmRIZWlnaHQoaGVpZ2h0KTt9LCBpbnRlcnZhbCk7XG4gIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGNsZWFySW50ZXJ2YWwodGhlSW50ZXJ2YWwpOyB9LCB0aW1lb3V0KTtcbiAgZnVuY3Rpb24gc2VuZEhlaWdodChoZWlnaHQpIHtcbiAgICB2YXIgaGVpZ2h0ID0gaGVpZ2h0IHx8IGRvY3VtZW50LmJvZHkub2Zmc2V0SGVpZ2h0O1xuICAgIHZhciB0YXJnZXRXaW5kb3cgPSBwYXJlbnQuZnJhbWVzO1xuICAgIHZhciBvYmogPSB7XG4gICAgICBhY3Rpb246ICdleHRlbnNpb25fdXBkYXRlX2hlaWdodCcsXG4gICAgICBoZWlnaHQ6IGhlaWdodCxcbiAgICAgIGlkOiBpZnJhbWVJZFxuICAgIH1cbiAgICB0YXJnZXRXaW5kb3cucG9zdE1lc3NhZ2Uob2JqLCAnKicpO1xuICB9XG4gIHNlbmRIZWlnaHQoaGVpZ2h0KTtcbn1cblxuRXh0ZW5zaW9uID0gZnVuY3Rpb24oKSB7fVxuRXh0ZW5zaW9uLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24ob3B0aW9ucykge1xuICAvLyBsZXQgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAvLyB7IGRpc2FibGVEZWZhdWx0OiBbJyonXSB9XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgP1xuICAgICAgICAgICAgICBvcHRpb25zIDpcbiAgICAgICAgICAgICAge307XG4gICAgb3B0aW9ucy5oZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodDtcbiAgICAvLyBpZiAoIW9wdGlvbnMgJiYgb3B0aW9ucy5kaXNhYmxlRGVmYXVsdCkge1xuICAgIC8vICAgcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25fZmllbGRfZGlzYWJsZV9kZWZhdWx0Jywge2ZpZWxkX2lkOiB0d2l4bHlGaWVsZC5pZCwgdmFsdWU6IG9wdGlvbnMuZGlzYWJsZURlZmF1bHR9KTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIHBvc3RNZXNzZW5nZXIuY2FsbCgnZXh0ZW5zaW9uX2luaXQnLCB7ZmllbGRfaWQ6IGZpZWxkSWQsIG9wdGlvbnM6IG9wdGlvbnN9KTtcbiAgICAvLyBmdW5jdGlvbiBjYWxsYmFjaygpIHtcbiAgICAvLyAgIC8vIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZGlzYWJsZURlZmF1bHQpIHtcbiAgICAvLyAgIC8vICAgcG9zdE1lc3Nlbmdlci5jYWxsKCdleHRlbnNpb25fZmllbGRfZGlzYWJsZV9kZWZhdWx0Jywge2ZpZWxkX2lkOiB0d2l4bHlGaWVsZC5pZCwgdmFsdWU6IG9wdGlvbnMuZGlzYWJsZURlZmF1bHR9KTtcbiAgICAvLyAgIC8vIH1cbiAgICAvLyAgIHJlc29sdmUodHdpeGx5RXh0ZW5zaW9uKTtcbiAgICAvLyB9XG4gICAgLy8gaWYgKFxuICAgIC8vICAgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJy8vIHx8XG4gICAgLy8gICAvLyhkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAnbG9hZGluZycgJiYgIWRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbClcbiAgICAvLyApIHtcbiAgICAvLyAgIGNhbGxiYWNrKCk7XG4gICAgLy8gfSBlbHNlIHtcbiAgICAvLyAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBjYWxsYmFjayk7XG4gICAgLy8gfVxuICAgIC8vIGZ1bmN0aW9uIGdvbygpIHtcbiAgICAvLyAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7XG4gICAgLy8gICAgIGNhbGxiYWNrKCk7XG4gICAgLy8gICB9IGVsc2Uge1xuICAgIC8vICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBnb28oKSB9LCAxKTtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG4gICAgLy8gZ29vKCk7XG4gIC8vIH0pO1xuICAvLyByZXR1cm4gcHJvbWlzZTtcbn1cblxudmFyIHBvc3RNZXNzZW5nZXIgPSBuZXcgUG9zdE1lc3NlbmdlcihpZnJhbWVJZCk7XG5cbndpbmRvdy50d2l4bHkgPSB7fTtcbndpbmRvdy50d2l4bHkuY2FsbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zKSB7XG4gIHJldHVybiBwb3N0TWVzc2VuZ2VyLmNhbGwobWV0aG9kLCBwYXJhbXMpO1xufVxud2luZG93LnR3aXhseS5leHRlbnNpb24gPSBuZXcgRXh0ZW5zaW9uO1xud2luZG93LnR3aXhseUV4dGVuc2lvbiA9IHdpbmRvdy50d2l4bHkuZXh0ZW5zaW9uOyJdfQ==
